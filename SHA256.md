# SHA256の計算方法

## 参考文献

- [SHA-256の実装](https://qiita.com/tnakagawa/items/6321472098a2b73836ab)
- URL：https://qiita.com/tnakagawa/items/6321472098a2b73836ab

多分上の記事を読んだ方がわかりやすいと思います。

## 前提

この記事中ではバイト列を全て16進数で表記する。
また、以下のように記号を定義する。

- `&` : ビット単位のAND
- `|` : ビット単位のOR
- `^` : ビット単位のXOR
- `~` : ビット単位のNOT
- `<<<` : 循環左シフト(右にはみ出たbitは左端に戻る。記法は上に同じ)
- `>>>` : 循環右シフト(上に同じ)
- `+` : 加算。ただし、32bitからのオーバーフローは無視する

## パディング

SHA256は、入力データの長さが512bit(= 64byte)の倍数になるようにパディングを行うが、その方法については具体的には説明しないので気になる方は参考文献を参照のこと。代わりに今回ハッシュ化を行うデータを以下に示す。

```
01000000 6fe28c0a b6f1b372 c1a6a246 ae63f74f 931e8365 e15a089c 68d61900
00000000 982051fd 1e4ba744 bbbe680e 1fee1467 7ba1a3c3 540bf7b1 cdb606e8
57233e0e 61bc6649 xxxxxxxx 01e36299 80000000 00000000 00000000 00000000
00000000 00000000 00000000 00000000 00000000 00000000 00000000 0000000c
```

ただし、`xxxxxxxx`の部分にはnonceをリトルエンディアンで表したバイト列が入る。

## ハッシュ化

### 関数の定義

以下のように関数を定義する。ただし、引数は全て32bitの整数とする。

- $Ch(x, y, z)$ : `(x & y) ^ (~x & z)`
- $Maj(x, y, z)$ : `(x & y) ^ (x & z) ^ (y & z)`
- $Σ_0(x)$ : `(x >>> 2) ^ (x >>> 13) ^ (x >>> 22)`
- $Σ_1(x)$ : `(x >>> 6) ^ (x >>> 11) ^ (x >>> 25)`
- $σ_0(x)$ : `(x >>> 7) ^ (x >>> 18) ^ (x >>> 3)`
- $σ_1(x)$ : `(x >>> 17) ^ (x >>> 19) ^ (x >>> 10)`

### 定数の定義

以下のように定数を定義する。各 $K_i$ について、これらの値は $i+1$ 番目の素数の立方根の小数部分の始めの32bitである。

- $K_0$ : `428a2f98`
- $K_1$ : `71374491`
- $K_2$ : `b5c0fbcf`
- $K_3$ : `e9b5dba5`
- $K_4$ : `3956c25b`
- $K_5$ : `59f111f1`
- $K_6$ : `923f82a4`
- $K_7$ : `ab1c5ed5`
- $K_8$ : `d807aa98`
- $K_9$ : `12835b01`
- $K_{10}$ : `243185be`
- $K_{11}$ : `550c7dc3`
- $K_{12}$ : `72be5d74`
- $K_{13}$ : `80deb1fe`
- $K_{14}$ : `9bdc06a7`
- $K_{15}$ : `c19bf174`
- $K_{16}$ : `e49b69c1`
- $K_{17}$ : `efbe4786`
- $K_{18}$ : `0fc19dc6`
- $K_{19}$ : `240ca1cc`
- $K_{20}$ : `2de92c6f`
- $K_{21}$ : `4a7484aa`
- $K_{22}$ : `5cb0a9dc`
- $K_{23}$ : `76f988da`
- $K_{24}$ : `983e5152`
- $K_{25}$ : `a831c66d`
- $K_{26}$ : `b00327c8`
- $K_{27}$ : `bf597fc7`
- $K_{28}$ : `c6e00bf3`
- $K_{29}$ : `d5a79147`
- $K_{30}$ : `06ca6351`
- $K_{31}$ : `14292967`
- $K_{32}$ : `27b70a85`
- $K_{33}$ : `2e1b2138`
- $K_{34}$ : `4d2c6dfc`
- $K_{35}$ : `53380d13`
- $K_{36}$ : `650a7354`
- $K_{37}$ : `766a0abb`
- $K_{38}$ : `81c2c92e`
- $K_{39}$ : `92722c85`
- $K_{40}$ : `a2bfe8a1`
- $K_{41}$ : `a81a664b`
- $K_{42}$ : `c24b8b70`
- $K_{43}$ : `c76c51a3`
- $K_{44}$ : `d192e819`
- $K_{45}$ : `d6990624`
- $K_{46}$ : `f40e3585`
- $K_{47}$ : `106aa070`
- $K_{48}$ : `19a4c116`
- $K_{49}$ : `1e376c08`
- $K_{50}$ : `2748774c`
- $K_{51}$ : `34b0bcb5`
- $K_{52}$ : `391c0cb3`
- $K_{53}$ : `4ed8aa4a`
- $K_{54}$ : `5b9cca4f`
- $K_{55}$ : `682e6ff3`
- $K_{56}$ : `748f82ee`
- $K_{57}$ : `78a5636f`
- $K_{58}$ : `84c87814`
- $K_{59}$ : `8cc70208`
- $K_{60}$ : `90befffa`
- $K_{61}$ : `a4506ceb`
- $K_{62}$ : `bef9a3f7`
- $K_{63}$ : `c67178f2`

### 初期値の定義

以下のように初期値を定義する。各 $H^0_i$ について、これらの値は $i+1$ 番目の素数の平方根の小数部分の始めの32bitである。

- $H^0_0$ : `6a09e667`
- $H^0_1$ : `bb67ae85`
- $H^0_2$ : `3c6ef372`
- $H^0_3$ : `a54ff53a`
- $H^0_4$ : `510e527f`
- $H^0_5$ : `9b05688c`
- $H^0_6$ : `1f83d9ab`
- $H^0_7$ : `5be0cd19`

### 計算の流れ

1. パディングされたデータを512bitずつに分割する。この時、分割されたデータを $M^1,\ldots, M^n$ とする。ただし、 $n$ は分割されたデータの個数(今回は $n = 2$ )である。さらに、 $M^i_j$ は $M^i$ の $j$ 番目のワード(32bitのかたまり)を表すとする。
1. 各 $i (= 1,2)$ について以下を行う
   1. メッセージ変数 $W_t\ (t=0,\cdots,63)$ を以下のように定義する
      - $W_t = M^i_t \quad (t=0,...,15)$
      - $W_t = σ_1(W_{t-2}) + W_{t-7} + σ_0(W_{t-15}) + W_{t-16} \quad (t=16,\cdots,63)$
    2. ハッシュ値変数 $a, b, c, d, e, f, g, h$ を以下のように定義する
       - $a = H^{i-1}_0$
       - $b = H^{i-1}_0$
       - $c = H^{i-1}_0$
       - $d = H^{i-1}_0$
       - $e = H^{i-1}_0$
       - $f = H^{i-1}_0$
       - $g = H^{i-1}_0$
       - $h = H^{i-1}_0$
    3. `t=0`から`63`まで以下の計算を行う
       - $T_1 = h + Σ_1(e) + Ch(e, f, g) + K_t + W_t$
       - $T_2 = Σ_0(a) + Maj(a, b, c)$
       - $h = g$
       - $g = f$
       - $f = e$
       - $e = d + T_1$
       - $d = c$
       - $c = b$
       - $b = a$
       - $a = T_1 + T_2$
    4. $i$ 番目のハッシュを計算する
       - $H^i_0 = a + H^{i-1}_0$
       - $H^i_1 = b + H^{i-1}_1$
       - $H^i_2 = c + H^{i-1}_2$
       - $H^i_3 = d + H^{i-1}_3$
       - $H^i_4 = e + H^{i-1}_4$
       - $H^i_5 = f + H^{i-1}_5$
       - $H^i_6 = g + H^{i-1}_6$
       - $H^i_7 = h + H^{i-1}_7$
1. $H^i_0, H^i_1, H^i_2, H^i_3, H^i_4, H^i_5, H^i_6, H^i_7$ を連結したものが求めるハッシュ値である
